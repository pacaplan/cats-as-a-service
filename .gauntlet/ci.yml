runtimes:
  ruby:
    version: "3.3.6"
    bundler_cache: true

services:
  postgres:
    image: postgres:16
    env:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports: ["5432:5432"]
    options: >-
      --health-cmd pg_isready
      --health-interval 10s
      --health-timeout 5s
      --health-retries 5

setup:
  - name: Global Setup
    run: echo "Global setup"

checks:
  - name: linter
    requires_runtimes: [ruby]

  - name: packwerk
    requires_runtimes: [ruby]
  
  - name: specs
    requires_runtimes: [ruby]
    requires_services: [postgres]
    setup:
       - name: DB Setup
         run: |
           export PGHOST=127.0.0.1
           export PGPORT=5432
           export PGUSER=postgres
           export PGPASSWORD=postgres

           # Create schemas for each engine
           psql -d postgres -c "CREATE SCHEMA IF NOT EXISTS identity;"
           psql -d postgres -c "CREATE SCHEMA IF NOT EXISTS cat_content;"

           # Run migrations for the engine (if in an engine directory)
           if [ -f "spec/dummy/config/application.rb" ]; then
             RAILS_ENV=test bundle exec rake db:migrate
           fi